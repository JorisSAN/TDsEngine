#include <stdio.h>
#include "bgfx/bgfx.h"
#include "bgfx/platform.h"
#include "bx/math.h"
#include "GLFW/glfw3.h"
#if BX_PLATFORM_LINUX
#define GLFW_EXPOSE_NATIVE_X11
#elif BX_PLATFORM_WINDOWS
#define GLFW_EXPOSE_NATIVE_WIN32
#elif BX_PLATFORM_OSX
#define GLFW_EXPOSE_NATIVE_COCOA
#endif
#include "GLFW/glfw3native.h"
#include "EngineUtils.h"
#include "Window.h"

#define WNDW_WIDTH 1024
#define WNDW_HEIGHT 768

int main(void)
{
    Window window(WNDW_WIDTH, WNDW_HEIGHT);
    if (window.init() == 1) {
        return 1;
    }

    /*
    -------------------------------------------------
        CUBE CREATION
    -------------------------------------------------
    */
    bgfx::VertexLayout pcvDecl;
    pcvDecl.begin()
        .add(bgfx::Attrib::Position, 3, bgfx::AttribType::Float)
        .add(bgfx::Attrib::Color0, 4, bgfx::AttribType::Uint8, true)
        .end();
    bgfx::VertexBufferHandle vbh = bgfx::createVertexBuffer(bgfx::makeRef(cubeVertices, sizeof(cubeVertices)), pcvDecl);
    bgfx::IndexBufferHandle ibh = bgfx::createIndexBuffer(bgfx::makeRef(cubeTriList, sizeof(cubeTriList)));

    bgfx::ShaderHandle vsh = loadShader("vs_cubes.bin");
    bgfx::ShaderHandle fsh = loadShader("fs_cubes.bin");
    bgfx::ProgramHandle program = bgfx::createProgram(vsh, fsh, true);
    /*
    -------------------------------------------------
    */

    unsigned int counter = 0;
    while (!window.windowShouldClose()) {
        window.update();
        /*
        -------------------------------------------------
            CUBE UPDATE
        -------------------------------------------------
        */
        const bx::Vec3 at = { 0.0f, 0.0f,  0.0f };
        const bx::Vec3 eye = { 0.0f, 0.0f, -5.0f };
        float view[16];
        bx::mtxLookAt(view, eye, at);
        float proj[16];
        bx::mtxProj(proj, 60.0f, float(window.getWidth()) / float(window.getHeight()), 0.1f, 100.0f, bgfx::getCaps()->homogeneousDepth);
        bgfx::setViewTransform(0, view, proj);

        float mtx[16];
        bx::mtxRotateXY(mtx, counter * 0.01f, counter * 0.01f);
        bgfx::setTransform(mtx);

        bgfx::setVertexBuffer(0, vbh);
        bgfx::setIndexBuffer(ibh);

        bgfx::submit(0, program);
        bgfx::frame();
        counter++;
        /*
        -------------------------------------------------
        */
    }

    /*
    -------------------------------------------------
        DESTROY FOR KILL PROGRAM
    -------------------------------------------------
    */
    bgfx::destroy(ibh);
    bgfx::destroy(vbh);
    bgfx::shutdown();
    window.shutdown();
    /*
    -------------------------------------------------
    */
    return 0;
}